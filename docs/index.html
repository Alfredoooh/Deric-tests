<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deriv Mobile — Login & Trading</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    html,body,#app { height:100%; }
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    /* mobile-friendly sizes */
    .big-btn { padding: 12px 16px; border-radius: 10px; font-weight:600; }
    .card { border-radius:12px; padding:12px; background:white; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
    .dark .card { background:#0f172a; box-shadow:none; }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100">
  <div id="app" class="max-w-lg mx-auto p-4">
    <header class="mb-4 flex items-center justify-between">
      <h1 class="text-xl font-bold">Deriv Mobile</h1>
      <button id="themeToggle" class="text-sm px-2 py-1 rounded bg-slate-200 dark:bg-slate-800">Theme</button>
    </header>

    <div id="loginCard" class="card mb-4">
      <p class="text-sm text-slate-600 dark:text-slate-300">Entrar com a tua conta Deriv para ver carteira, gráficos e operar.</p>
      <div class="mt-3 flex gap-2">
        <a id="loginBtn" class="big-btn no-underline bg-emerald-600 text-white w-full text-center">Entrar com Deriv</a>
      </div>
      <p id="loginNote" class="mt-2 text-xs text-slate-500">Depois do login, serás redirecionado de volta a esta página para escolher a conta.</p>
    </div>

    <div id="accountCard" class="card mb-4 hidden">
      <div class="flex items-center justify-between">
        <div>
          <div id="accountLogin" class="font-semibold"></div>
          <div id="accountCurrency" class="text-xs text-slate-500"></div>
        </div>
        <div>
          <button id="logoutBtn" class="px-3 py-1 rounded bg-rose-600 text-white">Sair</button>
        </div>
      </div>
      <div class="mt-3 grid grid-cols-2 gap-2">
        <div class="text-sm">Saldo</div>
        <div id="balance" class="font-bold text-right">—</div>
      </div>
    </div>

    <div id="controls" class="card mb-4 hidden">
      <label class="block text-sm">Símbolo</label>
      <select id="symbol" class="w-full p-2 rounded border my-2">
        <option value="R_100">R_100</option>
        <option value="R_50">R_50</option>
        <option value="R_25">R_25</option>
        <option value="R_10">R_10</option>
      </select>

      <label class="block text-sm">Stake (USD)</label>
      <input id="stake" type="number" value="1" min="1" class="w-full p-2 rounded border my-2" />

      <div class="flex gap-2 mt-2">
        <button id="buyBtn" class="big-btn bg-indigo-600 text-white w-1/2">Buy</button>
        <button id="subscribeBtn" class="big-btn bg-cyan-600 text-white w-1/2">Subscrever ticks</button>
      </div>
    </div>

    <div id="charts" class="mb-6 hidden">
      <div id="lineChart" class="card" style="height:220px;"></div>
    </div>

    <footer class="text-xs text-slate-400 text-center mt-4">
      App ID: <strong>71954</strong>
    </footer>
  </div>

  <script>
    // ========== CONFIG ==========
    const APP_ID = '71954';
    const REDIRECT_URI = 'https://alfredoooh.github.io/Deric-tests/index.html';
    const OAUTH_URL = 'https://oauth.deriv.com/oauth2/authorize?app_id=' + encodeURIComponent(APP_ID) + '&redirect_uri=' + encodeURIComponent(REDIRECT_URI);
    const BACKEND_BASE = (location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://your-backend.example.com'); // substitui pelo teu backend deploy

    // ========== UI refs ==========
    const loginBtn = document.getElementById('loginBtn');
    const loginCard = document.getElementById('loginCard');
    const accountCard = document.getElementById('accountCard');
    const accountLogin = document.getElementById('accountLogin');
    const accountCurrency = document.getElementById('accountCurrency');
    const balanceEl = document.getElementById('balance');
    const logoutBtn = document.getElementById('logoutBtn');
    const controls = document.getElementById('controls');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const buyBtn = document.getElementById('buyBtn');
    const charts = document.getElementById('charts');
    const lineChartEl = document.getElementById('lineChart');

    // lightweight-charts
    let chart = null, lineSeries = null;
    function initChart() {
      if (chart) return;
      chart = LightweightCharts.createChart(lineChartEl, { layout: { background: { color: window.getComputedStyle(document.body).backgroundColor } } });
      lineSeries = chart.addLineSeries();
    }

    // toggles
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
    });

    // ------------- Login flow -------------
    loginBtn.addEventListener('click', () => {
      // redirect the user to Deriv OAuth
      location.href = OAUTH_URL;
    });

    // On load, check URL params for OAuth tokens
    (function parseOAuthRedirect() {
      // Deriv appends query parameters with accounts & tokens.
      // Parse both search and hash for safety.
      const params = new URLSearchParams(window.location.search + window.location.hash.replace(/^#/, '?'));
      // Build accounts array: each param may be like 'acct_XXXX' or 'loginid_XXX' or custom keys.
      const keys = Array.from(params.keys());
      if (keys.length === 0) {
        // no redirect data
        checkSession(); // check if user already has session cookie via backend
        return;
      }

      // Convert params to array of { key, value } and try to detect account tokens.
      // Deriv often returns tokens & loginids; we try to find tokens by pattern (bearer-like) or keys containing 'token' or 'authorized' or values that look long.
      const entries = [];
      for (const [k,v] of params.entries()) entries.push({k,v});

      // heurística: possíveis tokens serão valores longos > 20 chars; login ids contain letters+digits.
      const detected = [];
      for (const e of entries) {
        if (e.k.toLowerCase().includes('token') || e.v.length > 20) {
          detected.push(e);
        }
      }

      // If nothing strong detected, fallback: treat each param as token candidate
      const candidates = detected.length ? detected : entries;

      // Present choices to user if multiple tokens/accounts found
      if (candidates.length === 0) { checkSession(); return; }

      // If only one candidate, send to backend directly
      if (candidates.length === 1) {
        saveTokenToBackend(candidates[0].v);
        // tidy URL: remove params from addressbar
        history.replaceState({}, document.title, location.pathname);
        return;
      }

      // Multiple: build quick chooser (simple prompt)
      const choiceList = candidates.map((c,i) => `${i+1}: ${c.k} → ${c.v.slice(0,12)}...`).join('\n');
      const pick = prompt('Foram retornados múltiplos tokens/params:\n' + choiceList + '\nEscolhe o número (1..' + candidates.length + ')');
      const idx = parseInt(pick||'') - 1;
      if (!isNaN(idx) && candidates[idx]) {
        saveTokenToBackend(candidates[idx].v);
      } else {
        alert('Nenhuma escolha válida. Se preferir repete o login.');
      }
      history.replaceState({}, document.title, location.pathname);
    })();

    // Sends token to backend store-token endpoint to create httpOnly session cookie
    async function saveTokenToBackend(token) {
      try {
        const res = await fetch(BACKEND_BASE + '/store-token', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token })
        });
        const j = await res.json();
        if (j.ok) {
          // user session created — now connect to proxy WS
          await connectToProxy(); // will fetch account info
          return;
        } else {
          alert('Erro ao registar token: ' + (j.error || JSON.stringify(j)));
        }
      } catch (err) {
        alert('Erro de rede: ' + err.message);
      }
    }

    // Check if user already has session (cookie) — ask backend for account info
    async function checkSession() {
      try {
        const r = await fetch(BACKEND_BASE + '/me', { credentials:'include' });
        if (r.status === 200) {
          const j = await r.json();
          if (j.authorized) {
            // show account UI
            showAccount(j);
            await connectToProxy();
            return;
          }
        }
      } catch(e){}
    }

    // ---------- Connect to backend proxy (WebSocket) -----------
    let ws = null;
    async function connectToProxy() {
      try {
        // create WS to backend at /client-proxy
        const url = (BACKEND_BASE.replace(/^http/, 'ws')) + '/client-proxy';
        ws = new WebSocket(url);
        ws.onopen = () => {
          console.log('WS proxy connected');
          showControls();
        };
        ws.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            handleProxyMsg(msg);
          } catch(e) {}
        };
        ws.onclose = () => { console.log('proxy closed'); };
        ws.onerror = (e) => { console.error('proxy error', e); };
      } catch (err) {
        console.error('connectProxy err', err);
      }
    }

    function handleProxyMsg(msg) {
      if (msg.type === 'authorized') {
        // backend will also send me account info after authorize
        if (msg.account) showAccount(msg.account);
      } else if (msg.type === 'tick') {
        const q = parseFloat(msg.quote);
        const t = Math.floor(msg.epoch);
        initChart();
        lineSeries.update({ time: t, value: q });
      } else if (msg.type === 'balance') {
        balanceEl.textContent = msg.balance;
      } else if (msg.type === 'buy_result') {
        alert('Buy result: ' + JSON.stringify(msg.result));
      } else if (msg.type === 'error') {
        console.warn('proxy error', msg.message || msg);
      }
    }

    function showAccount(acc) {
      loginCard.classList.add('hidden');
      accountCard.classList.remove('hidden');
      controls.classList.remove('hidden');
      charts.classList.remove('hidden');
      accountLogin.textContent = acc.loginid || '—';
      accountCurrency.textContent = acc.currency ? 'Currency: ' + acc.currency : '';
      balanceEl.textContent = (acc.balance !== undefined) ? acc.balance : '—';
    }

    function showControls() {
      subscribeBtn.addEventListener('click', () => {
        const sym = document.getElementById('symbol').value;
        if (ws && ws.readyState === 1) {
          ws.send(JSON.stringify({ type:'subscribe', symbol: sym }));
        } else alert('Não conectado ao proxy');
      });
      buyBtn.addEventListener('click', async () => {
        const symbol = document.getElementById('symbol').value;
        const stake = parseFloat(document.getElementById('stake').value || '1');
        // simple call to backend buy
        try {
          const r = await fetch(BACKEND_BASE + '/api/buy', {
            method:'POST',
            credentials:'include',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ symbol, stake })
          });
          const j = await r.json();
          if (!j.ok) alert('Erro buy: ' + (j.error || JSON.stringify(j)));
          else alert('Compra enviada: ' + JSON.stringify(j));
        } catch(e) { alert('Erro rede: ' + e.message); }
      });
    }

    // logout: call backend to clear session cookie
    logoutBtn.addEventListener('click', async () => {
      await fetch(BACKEND_BASE + '/logout', { method:'POST', credentials:'include' });
      location.reload();
    });

    // initial session check
    checkSession();
  </script>
</body>
</html>
